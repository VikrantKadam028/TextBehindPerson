<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Text Overlay - Place Text Behind People</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Use WebFontLoader to dynamically fetch fonts when needed -->
    <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <style>
        :root {
            --primary-color: #6366f1; /* Indigo 500 */
            --secondary-color: #f1f5f9; /* Slate 100 */
            --bg-color: #0f172a; /* Slate 900 */
            --text-color: #f8fafc; /* Slate 50 */
            --card-bg: rgba(30, 41, 59, 0.7); /* Slate 800 with transparency */
            --border-color: rgba(71, 85, 105, 0.5); /* Slate 600 with transparency */
            --shadow-color: rgba(0, 0, 0, 0.25);
        }
        [data-theme='light'] {
            --primary-color: #4f46e5; /* Indigo 600 */
            --secondary-color: #e2e8f0; /* Slate 200 */
            --bg-color: #f8fafc; /* Slate 50 */
            --text-color: #0f172a; /* Slate 900 */
            --card-bg: rgba(255, 255, 255, 0.8);
            --border-color: rgba(226, 232, 240, 0.5);
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .bg-glass {
            background-color: var(--card-bg);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid var(--border-color);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #334155; /* Slate 700 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569; /* Slate 600 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* Slate 500 */
        }
        .text-shadow {
            text-shadow: 2px 2px 6px rgba(0,0,0,0.4);
        }
        .text-glow {
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--secondary-color);
            box-shadow: 0 0 4px var(--shadow-color);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .range-slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid var(--secondary-color);
            box-shadow: 0 0 4px var(--shadow-color);
            transition: background-color 0.2s ease, transform 0.2s ease;
        }
        .range-slider:active::-webkit-slider-thumb {
            transform: scale(1.2);
        }
        .range-slider:active::-moz-range-thumb {
            transform: scale(1.2);
        }
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spin 1.5s linear infinite;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in {
            animation: fadeIn 0.5s ease-out;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-50 antialiased">
    <!-- Header -->
    <header class="bg-glass backdrop-blur-xl sticky top-0 z-50 shadow-lg border-b border-slate-700">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-indigo-400" viewBox="0 0 256 256">
                    <path fill="currentColor" d="M128 24a104 104 0 1 0 104 104A104.11 104.11 0 0 0 128 24m0 192a88 88 0 1 1 88-88a88.1 88.1 0 0 1-88 88m48-112v-16a8 8 0 0 0-8-8h-32a8 8 0 0 0-8 8v16a8 8 0 0 0-16 0v-16a24 24 0 0 1 24-24h32a24 24 0 0 1 24 24v16a8 8 0 0 0-16 0m-48 64h-16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h16a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8m40 0h-16a8 8 0 0 0-8 8v16a8 8 0 0 0 8 8h16a8 8 0 0 0 8-8v-16a8 8 0 0 0-8-8"/>
                </svg>
                <h1 class="text-2xl md:text-3xl font-extrabold text-white">
                    Photo Text Overlay
                </h1>
            </div>
            <p class="text-sm text-slate-400 hidden md:block">Place text behind people in photos</p>
            <button id="themeToggleBtn" class="p-2 rounded-full text-slate-400 hover:text-white transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <main class="grid lg:grid-cols-3 gap-8">
            <!-- Left Column - Upload & Preview -->
            <div class="lg:col-span-2">
                <!-- Upload Area -->
                <section class="bg-glass rounded-3xl shadow-2xl p-8 mb-8 border border-slate-700 animate-in">
                    <h2 class="text-2xl font-bold mb-4 text-white">Upload Photo</h2>
                    
                    <div id="dropZone" class="border-2 border-dashed border-slate-600 rounded-2xl p-12 text-center hover:border-indigo-400 hover:bg-slate-800 transition-all duration-300 cursor-pointer">
                        <div class="space-y-4">
                            <svg class="w-12 h-12 mx-auto text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <div>
                                <p class="text-lg font-medium text-white">Drop your photo here</p>
                                <p class="text-slate-400 text-sm">or click to browse</p>
                            </div>
                            <button type="button" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-full font-semibold shadow-md transform hover:scale-105 transition-all duration-200">
                                Choose File
                            </button>
                        </div>
                    </div>
                    
                    <input type="file" id="fileInput" accept="image/*" class="hidden">
                </section>

                <!-- Preview Area -->
                <section class="bg-glass rounded-3xl shadow-2xl p-8 border border-slate-700 animate-in">
                    <h2 class="text-2xl font-bold mb-4 text-white">Preview</h2>
                    
                    <div id="previewContainer" class="relative bg-slate-800 rounded-2xl overflow-hidden min-h-[500px] flex items-center justify-center">
                        <div id="emptyState" class="text-center p-8">
                            <svg class="w-20 h-20 mx-auto text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                            <p class="text-slate-400">Upload a photo to get started</p>
                        </div>
                        
                        <!-- Canvas for compositing -->
                        <canvas id="compositeCanvas" class="hidden max-w-full max-h-[70vh] rounded-xl shadow-xl"></canvas>
                        
                        <!-- Loading Overlay -->
                        <div id="loadingOverlay" class="absolute inset-0 bg-slate-900 bg-opacity-75 flex items-center justify-center hidden">
                            <div class="flex flex-col items-center">
                                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                                <span class="text-white text-lg font-medium">Removing background...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Download Button -->
                    <div class="mt-8 text-center">
                        <button id="downloadBtn" class="hidden bg-green-500 hover:bg-green-600 text-white px-8 py-3 rounded-full font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200">
                            <svg class="w-5 h-5 inline mr-2 -mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-4-4m4 4l4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Download Image
                        </button>
                    </div>
                </section>
            </div>

            <!-- Right Column - Controls -->
            <div class="lg:col-span-1">
                <section id="controlPanel" class="hidden bg-glass rounded-3xl shadow-2xl p-8 border border-slate-700 lg:sticky lg:top-24 animate-in">
                    <h2 class="text-2xl font-bold mb-6 text-white">Text Settings</h2>
                    
                    <div class="space-y-6 custom-scrollbar max-h-[calc(100vh-200px)] overflow-y-auto pr-2">
                        <!-- Text Input -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Your Text</label>
                            <textarea id="textInput" placeholder="Enter your text here..." class="w-full p-3 bg-slate-800 text-white border border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none h-20 transition-colors"></textarea>
                        </div>

                        <!-- Font Family -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Font</label>
                            <select id="fontFamily" class="w-full p-3 bg-slate-800 text-white border border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-colors">
                                <option>Loading fonts...</option>
                            </select>
                        </div>

                        <!-- Font Boldness -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">
                                Boldness: <span id="fontWeightValue" class="font-bold text-indigo-400">400</span>
                            </label>
                            <input type="range" id="fontWeight" min="100" max="900" step="100" value="400" class="range-slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        
                        <!-- Text Color -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Color</label>
                            <div class="flex space-x-2 items-center">
                                <input type="color" id="textColor" value="#ffffff" class="w-12 h-12 bg-slate-800 border-2 border-slate-700 rounded-xl cursor-pointer transition-colors">
                                <input type="text" id="textColorHex" value="#ffffff" class="flex-1 p-3 bg-slate-800 text-white border border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent font-mono text-sm transition-colors">
                            </div>
                        </div>

                        <!-- Font Size -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">
                                Size: <span id="fontSizeValue" class="font-bold text-indigo-400">48</span>px
                            </label>
                            <input type="range" id="fontSize" min="12" max="200" value="48" class="range-slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Letter Spacing -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">
                                Letter Spacing: <span id="letterSpacingValue" class="font-bold text-indigo-400">0</span>px
                            </label>
                            <input type="range" id="letterSpacing" min="-5" max="20" value="0" class="range-slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Line Height -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">
                                Line Height: <span id="lineHeightValue" class="font-bold text-indigo-400">1.2</span>
                            </label>
                            <input type="range" id="lineHeight" min="0.8" max="2.5" step="0.1" value="1.2" class="range-slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>
                        
                        <!-- Text Curve -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">
                                Text Curve: <span id="textCurveValue" class="font-bold text-indigo-400">0</span>°
                            </label>
                            <input type="range" id="textCurve" min="-180" max="180" step="10" value="0" class="range-slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- Text Effects -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Effects</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="textEffect" value="none" checked class="form-radio text-indigo-500 h-4 w-4">
                                        <span class="text-sm text-slate-300">None</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="textEffect" value="shadow" class="form-radio text-indigo-500 h-4 w-4">
                                        <span class="text-sm text-slate-300">Shadow</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="textEffect" value="glow" class="form-radio text-indigo-500 h-4 w-4">
                                        <span class="text-sm text-slate-300">Glow</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Text Stroke -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Text Outline</label>
                            <div class="flex items-center space-x-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="textStrokeEnabled" class="form-checkbox h-5 w-5 text-indigo-500 rounded-md">
                                    <span class="text-sm text-slate-300">Enable</span>
                                </label>
                                <input type="color" id="textStrokeColor" value="#000000" class="w-12 h-12 bg-slate-800 border-2 border-slate-700 rounded-xl cursor-pointer transition-colors">
                                <input type="range" id="textStrokeWidth" min="1" max="10" value="2" class="range-slider w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                        
                        <!-- Image Filters -->
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Image Filters</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="imageFilter" value="none" checked class="form-radio text-indigo-500 h-4 w-4">
                                        <span class="text-sm text-slate-300">None</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="imageFilter" value="grayscale" class="form-radio text-indigo-500 h-4 w-4">
                                        <span class="text-sm text-slate-300">Grayscale</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="imageFilter" value="sepia" class="form-radio text-indigo-500 h-4 w-4">
                                        <span class="text-sm text-slate-300">Sepia</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="flex items-center space-x-2">
                                        <input type="radio" name="imageFilter" value="invert" class="form-radio text-indigo-500 h-4 w-4">
                                        <span class="text-sm text-slate-300">Invert</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        // Global variables
        let originalImage = null;
        let foregroundImage = null;
        let backgroundImage = null;
        let canvas = null;
        let ctx = null;
        let isDragging = false;
        let dragOffsetX = 0;
        let dragOffsetY = 0;
        let textX = 0;
        let textY = 0;

        // Initialize the application
        function init() {
            canvas = document.getElementById('compositeCanvas');
            ctx = canvas.getContext('2d');
            setupEventListeners();
            populateFontDropdown();
            // Set initial text color to white for better visibility on most photos
            document.getElementById('textColor').value = '#ffffff';
            document.getElementById('textColorHex').value = '#ffffff';
            
            // Apply initial position for text
            textX = canvas.width / 2;
            textY = canvas.height / 2;
        }

        // Populate font dropdown dynamically from Google Fonts API
        async function populateFontDropdown() {
            const fontFamilySelect = document.getElementById('fontFamily');
            fontFamilySelect.innerHTML = '<option disabled selected>Loading fonts...</option>';
            
            try {
                // Fetch the list of fonts from the Google Fonts API
                const response = await fetch('https://www.googleapis.com/webfonts/v1/webfonts?key=AIzaSyDYun3iEKXcgvPXqe5haLrehsjfgV02vvE');
                if (!response.ok) {
                    throw new Error('Failed to fetch fonts from Google Fonts API.');
                }

                const data = await response.json();
                const fonts = data.items;

                // Clear the dropdown and add default option
                fontFamilySelect.innerHTML = '<option value="Inter">Inter (default)</option>';

                fonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font.family;
                    option.textContent = font.family;
                    fontFamilySelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching Google Fonts:', error);
                fontFamilySelect.innerHTML = '<option value="Inter">Error loading fonts (using Inter)</option>';
                // Fallback to a hardcoded list if the API fails
                const fallbackFonts = [
                    "Roboto", "Open Sans", "Montserrat", "Poppins", "Playfair Display"
                ];
                fallbackFonts.forEach(font => {
                    const option = document.createElement('option');
                    option.value = font;
                    option.textContent = font;
                    fontFamilySelect.appendChild(option);
                });
            }
        }
        
        // Setup all event listeners
        function setupEventListeners() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const themeToggleBtn = document.getElementById('themeToggleBtn');

            // File upload events
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.add('border-indigo-400', 'bg-slate-800');
            });
            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('border-indigo-400', 'bg-slate-800');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                e.currentTarget.classList.remove('border-indigo-400', 'bg-slate-800');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    processFile(files[0]);
                }
            });
            fileInput.addEventListener('change', handleFileSelect);

            // Text control events
            document.getElementById('textInput').addEventListener('input', updatePreview);
            document.getElementById('fontFamily').addEventListener('change', (e) => {
                const selectedFont = e.target.value;
                WebFont.load({
                    google: { families: [selectedFont] },
                    active: updatePreview,
                    inactive: () => {
                        console.error(`Failed to load font: ${selectedFont}`);
                        updatePreview();
                    }
                });
            });
            document.getElementById('fontWeight').addEventListener('input', updateFontWeight);
            document.getElementById('textColor').addEventListener('input', updateColorFromPicker);
            document.getElementById('textColorHex').addEventListener('input', updateColorFromHex);
            document.getElementById('fontSize').addEventListener('input', updateFontSize);
            document.getElementById('letterSpacing').addEventListener('input', updateLetterSpacing);
            document.getElementById('lineHeight').addEventListener('input', updateLineHeight);
            document.getElementById('textCurve').addEventListener('input', updateTextCurve);
            
            // Text effects
            document.querySelectorAll('input[name="textEffect"]').forEach(radio => {
                radio.addEventListener('change', updatePreview);
            });
            document.getElementById('textStrokeEnabled').addEventListener('change', updatePreview);
            document.getElementById('textStrokeColor').addEventListener('input', updatePreview);
            document.getElementById('textStrokeWidth').addEventListener('input', updatePreview);

            // Image filters
            document.querySelectorAll('input[name="imageFilter"]').forEach(radio => {
                radio.addEventListener('change', updatePreview);
            });

            // Download button
            document.getElementById('downloadBtn').addEventListener('click', downloadImage);

            // Theme toggle
            themeToggleBtn.addEventListener('click', toggleTheme);

            // Drag-and-drop text events
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseleave', handleMouseUp); // End drag if mouse leaves canvas
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', handleTouchEnd);
        }

        // Handle file selection
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }

        // Process uploaded file
        async function processFile(file) {
            if (!file.type.startsWith('image/')) {
                showModal('Please select an image file.');
                return;
            }

            try {
                showLoadingOverlay();
                
                originalImage = await loadImage(file);
                
                setupCanvas();
                
                await removeBackground(file);
                
                showControls();
                updatePreview();
                hideLoadingOverlay();
                
            } catch (error) {
                console.error('Error processing file:', error);
                showModal('Error processing image. Please try again.');
                hideLoadingOverlay();
            }
        }
        
        // Function to show a custom modal instead of alert()
        function showModal(message) {
            const modalHtml = `
                <div class="fixed inset-0 bg-slate-900 bg-opacity-70 backdrop-blur-sm overflow-y-auto h-full w-full flex items-center justify-center z-[1000]" id="alertModal">
                    <div class="relative mx-auto p-8 w-96 max-w-sm rounded-xl bg-glass border border-slate-700 shadow-2xl animate-in">
                        <div class="mt-3 text-center">
                            <h3 class="text-xl font-bold text-white mb-2">Notice</h3>
                            <div class="mt-2 px-2 py-3">
                                <p class="text-sm text-slate-300">${message}</p>
                            </div>
                            <div class="items-center px-4 py-3">
                                <button id="closeModalBtn" class="px-6 py-2 bg-indigo-600 text-white font-medium rounded-full w-full shadow-lg hover:bg-indigo-700 transition-colors duration-200">
                                    OK
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('closeModalBtn').addEventListener('click', () => {
                document.getElementById('alertModal').remove();
            });
        }

        // Load image from file
        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Setup canvas dimensions based on image
        function setupCanvas() {
            if (!originalImage) return;
            
            const previewContainer = document.getElementById('previewContainer');
            const maxWidth = previewContainer.clientWidth;
            const maxHeight = previewContainer.clientHeight;
            
            let width = originalImage.width;
            let height = originalImage.height;
            
            // Scale down if too large, maintaining aspect ratio
            if (width > maxWidth || height > maxHeight) {
                const ratio = Math.min(maxWidth / width, maxHeight / height);
                width *= ratio;
                height *= ratio;
            }
            
            canvas.width = width;
            canvas.height = height;
            canvas.style.display = 'block';
            
            document.getElementById('emptyState').style.display = 'none';

            // Reset text position to center of new canvas size
            textX = canvas.width / 2;
            textY = canvas.height / 2;
        }

        // Remove background using Remove.bg API
        async function removeBackground(file) {
            const apiKey = 'NkZD7ccLywbiRmmdMo8dWiJL';

            const formData = new FormData();
            formData.append('image_file', file);
            formData.append('size', 'auto');

            try {
                const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                    method: 'POST',
                    headers: {
                        'X-Api-Key': apiKey,
                    },
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.errors?.[0]?.title || 'Failed to remove background');
                }

                const blob = await response.blob();
                
                foregroundImage = new Image();
                foregroundImage.onload = () => {
                    updatePreview();
                };
                foregroundImage.src = URL.createObjectURL(blob);
                
                backgroundImage = originalImage;
                
            } catch (error) {
                console.error('Background removal error:', error);
                throw error;
            }
        }

        // Show loading overlay
        function showLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        // Hide loading overlay
        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // Show control panel
        function showControls() {
            document.getElementById('controlPanel').classList.remove('hidden');
        }

        // Update preview with current settings
        function updatePreview() {
            if (!canvas || !ctx || !backgroundImage || !foregroundImage) return;

            setupCanvas();
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Apply image filter to the background image
            const filter = document.querySelector('input[name="imageFilter"]:checked').value;
            ctx.filter = filter === 'none' ? 'none' : `${filter}(100%)`;
            
            ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);

            // Clear filter before drawing text
            ctx.filter = 'none';

            drawText();

            ctx.drawImage(foregroundImage, 0, 0, canvas.width, canvas.height);

            document.getElementById('downloadBtn').classList.remove('hidden');
        }

        // Draw text on canvas
        function drawText() {
            const text = document.getElementById('textInput').value;
            if (!text.trim()) return;

            const fontFamily = document.getElementById('fontFamily').value;
            const fontWeight = document.getElementById('fontWeight').value;
            const fontSize = document.getElementById('fontSize').value;
            const textColor = document.getElementById('textColor').value;
            const letterSpacing = document.getElementById('letterSpacing').value;
            const lineHeight = document.getElementById('lineHeight').value;
            const curveDegrees = parseFloat(document.getElementById('textCurve').value);
            const effect = document.querySelector('input[name="textEffect"]:checked').value;
            const isStrokeEnabled = document.getElementById('textStrokeEnabled').checked;
            const strokeColor = document.getElementById('textStrokeColor').value;
            const strokeWidth = document.getElementById('textStrokeWidth').value;

            // Set font with weight
            ctx.font = `${fontWeight} ${fontSize}px "${fontFamily}"`;
            ctx.fillStyle = textColor;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            // Apply text effects
            ctx.shadowColor = 'transparent';
            ctx.shadowOffsetX = 0;
            ctx.shadowOffsetY = 0;
            ctx.shadowBlur = 0;

            if (effect === 'shadow') {
                ctx.shadowColor = 'rgba(0, 0, 0, 0.4)';
                ctx.shadowOffsetX = 3;
                ctx.shadowOffsetY = 3;
                ctx.shadowBlur = 6;
            } else if (effect === 'glow') {
                ctx.shadowColor = textColor;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;
                ctx.shadowBlur = 10;
            }
            
            // Text stroke
            if (isStrokeEnabled) {
                ctx.strokeStyle = strokeColor;
                ctx.lineWidth = strokeWidth;
            }

            const lines = text.split('\n');

            if (curveDegrees !== 0) {
                // Draw curved text
                drawCurvedText(lines, curveDegrees, letterSpacing, lineHeight, isStrokeEnabled);
            } else {
                // Draw straight text
                const lineHeightPx = fontSize * parseFloat(lineHeight);
                const startY = textY - ((lines.length - 1) * lineHeightPx) / 2;

                lines.forEach((line, index) => {
                    const currentY = startY + (index * lineHeightPx);
                    if (letterSpacing != 0) {
                        drawTextWithSpacing(line, textX, currentY, letterSpacing, isStrokeEnabled);
                    } else {
                        ctx.fillText(line, textX, currentY);
                        if (isStrokeEnabled) {
                            ctx.strokeText(line, textX, currentY);
                        }
                    }
                });
            }
        }
        
        // Draw curved text
        function drawCurvedText(lines, curveDegrees, letterSpacing, lineHeight, isStrokeEnabled) {
            const fontSize = document.getElementById('fontSize').value;
            const angleStep = curveDegrees / (lines[0].length); // Rough angle step per character
            
            lines.forEach((line, lineIndex) => {
                const lineAngleOffset = (lineIndex * fontSize * parseFloat(lineHeight) * 0.05); // Simple offset for multiple lines
                const radius = Math.abs(canvas.width) * (0.5 + (lineAngleOffset / canvas.height));
                const startAngle = -Math.PI / 2 - (curveDegrees * Math.PI / 180) / 2;
                
                ctx.save();
                ctx.translate(textX, textY);
                ctx.rotate(startAngle);
                
                const characters = line.split('');
                characters.forEach((char) => {
                    ctx.rotate(angleStep * Math.PI / 180);
                    ctx.save();
                    ctx.translate(0, -radius);
                    ctx.fillText(char, 0, 0);
                    if (isStrokeEnabled) {
                        ctx.strokeText(char, 0, 0);
                    }
                    ctx.restore();
                });
                ctx.restore();
            });
        }

        // Draw text with custom letter spacing
        function drawTextWithSpacing(text, x, y, spacing, isStrokeEnabled) {
            const chars = text.split('');
            let totalWidth = 0;
            chars.forEach(char => totalWidth += ctx.measureText(char).width);
            totalWidth += parseFloat(spacing) * (chars.length - 1);
            
            let currentX = x - totalWidth / 2;
            
            chars.forEach(char => {
                ctx.fillText(char, currentX, y);
                if (isStrokeEnabled) {
                    ctx.strokeText(char, currentX, y);
                }
                currentX += ctx.measureText(char).width + parseFloat(spacing);
            });
        }

        // Drag-and-drop text functionality
        function handleMouseDown(e) {
            if (!originalImage) return;

            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            const text = document.getElementById('textInput').value;
            if (text.trim()) {
                const textMetrics = ctx.measureText(text);
                const textWidth = textMetrics.width;
                const textHeight = parseFloat(document.getElementById('fontSize').value);
                const textLeft = textX - textWidth / 2;
                const textTop = textY - textHeight / 2;

                if (mouseX > textLeft && mouseX < textLeft + textWidth && mouseY > textTop && mouseY < textTop + textHeight) {
                    isDragging = true;
                    dragOffsetX = mouseX - textX;
                    dragOffsetY = mouseY - textY;
                    canvas.style.cursor = 'grabbing';
                }
            }
        }
        
        function handleMouseMove(e) {
            if (!isDragging) return;
            const rect = canvas.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;

            textX = mouseX - dragOffsetX;
            textY = mouseY - dragOffsetY;
            updatePreview();
        }

        function handleMouseUp() {
            isDragging = false;
            canvas.style.cursor = 'grab';
        }

        // Touch event handlers for mobile
        function handleTouchStart(e) {
            e.preventDefault();
            handleMouseDown({
                clientX: e.touches[0].clientX,
                clientY: e.touches[0].clientY
            });
        }

        function handleTouchMove(e) {
            e.preventDefault();
            handleMouseMove({
                clientX: e.touches[0].clientX,
                clientY: e.touches[0].clientY
            });
        }

        function handleTouchEnd() {
            handleMouseUp();
        }

        // Update color from color picker
        function updateColorFromPicker() {
            const color = document.getElementById('textColor').value;
            document.getElementById('textColorHex').value = color;
            updatePreview();
        }

        // Update color from hex input
        function updateColorFromHex() {
            const color = document.getElementById('textColorHex').value;
            if (/^#[0-9A-F]{6}$/i.test(color)) {
                document.getElementById('textColor').value = color;
                updatePreview();
            }
        }

        // Update font weight display
        function updateFontWeight() {
            const value = document.getElementById('fontWeight').value;
            document.getElementById('fontWeightValue').textContent = value;
            updatePreview();
        }

        // Update font size display
        function updateFontSize() {
            const value = document.getElementById('fontSize').value;
            document.getElementById('fontSizeValue').textContent = value;
            updatePreview();
        }

        // Update letter spacing display
        function updateLetterSpacing() {
            const value = document.getElementById('letterSpacing').value;
            document.getElementById('letterSpacingValue').textContent = value;
            updatePreview();
        }

        // Update line height display
        function updateLineHeight() {
            const value = document.getElementById('lineHeight').value;
            document.getElementById('lineHeightValue').textContent = value;
            updatePreview();
        }
        
        // Update text curve display
        function updateTextCurve() {
            const value = document.getElementById('textCurve').value;
            document.getElementById('textCurveValue').textContent = value;
            updatePreview();
        }

        // Download the final image
        function downloadImage() {
            if (!canvas) return;

            // Create download link
            const link = document.createElement('a');
            link.download = 'photo-text-overlay.png';
            link.href = canvas.toDataURL('image/png');
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Toggle between light and dark themes
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
        }

        // Initialize app when DOM loads
        document.addEventListener('DOMContentLoaded', init);
        window.addEventListener('resize', () => {
            if (originalImage) {
                updatePreview();
            }
        });
    </script>
</body>
</html>
